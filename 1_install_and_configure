# copyleft 2015 teodorescu.serban@gmail.com

# update the system and install minimal required stuff
echo "Update the host system. Please wait."
apt-get -qq update;
apt-get -qq upgrade;
echo "Done."
echo "Install a few dependencies."
apt-get -qq -y install tmux mc gettext-base python-pip git apparmor
echo "Done."

# install latest docker
echo "Installing docker. Please wait."
curl -sSL https://get.docker.com/ubuntu/ | sh >/dev/null
echo "Done."
# customize the docker aufs location
echo "Change docker aufs location to /data/docker"
mkdir -p /data
echo "DOCKER_OPTS=\"-g /data/docker\"" >> /etc/default/docker
restart docker
echo "Done"

# install docker tools
echo "Install docker tools. Please wait."
curl --fail -sL -O \
    https://github.com/phusion/baseimage-docker/archive/master.tar.gz
tar xzf master.tar.gz
./baseimage-docker-master/install-tools.sh > /dev/null
rm -rf master.tar.gz
rm -rf baseimage-docker-master
echo "Done."

# install docker compose (and pip if it's not yet installed)
echo "Install pip. Please wait."
which pip > /dev/null
[ $? -eq 0 ] || apt-get install -qq -y python-pip

pip install docker-compose > /dev/null
echo "Done."

echo "Install docker compose bash completion."
curl -sL https://raw.githubusercontent.com/docker/compose/1.1.0/contrib/completion/bash/docker-compose > /etc/bash_completion.d/docker-compose
echo "Done."

echo "Install and configure docker and docker-compose complete."
echo "Please hit Ctrl+C if you saw an error."
echo "Otherwise I will proceed to the next step in 10 seconds."
sleep 10

echo "Preparing for the the next step."
chmod u+x /hdx/hdx-install/2_review_vars_and_prepare_config_file
#exec /hdx/hdx-install/2_review_vars_and_prepare_config_file
